<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Measurement</title>
  <link rel="stylesheet" href="/styles.css">
  <script>
let websocket = null;
let dp = null;
let func = null;
let range = null;
let speed = null;
let flags = null;
let btnSelected = 'rgb(0, 255, 128)';
const FL_OFFSET = 0x8;
const FL_MANUAL = 0x4;
const FL_REARIN = 0x2;
const FL_EXTRIG = 0x1;
const funcindex = [0, 0, 1, 1, 2, 2];
const unitinfo = [
  [ {unit: "mV", dp: 4, lsb: 1E-7},
    {unit: "mV", dp: 3, lsb: 1E-6},
    {unit: "V",  dp: 5, lsb: 1E-5},
    {unit: "V",  dp: 4, lsb: 1E-4},
    {unit: "V",  dp: 3, lsb: 1E-3},
    {unit: "V",  dp: 2, lsb: 1E-2},
    {unit: "-",  dp: 1, lsb: 1E-1} ],

  [ {unit: "R",  dp: 4, lsb: 1E-7},
    {unit: "R",  dp: 3, lsb: 1E-6},
    {unit: "kR", dp: 5, lsb: 1E-5},
    {unit: "kR", dp: 4, lsb: 1E-4},
    {unit: "kR", dp: 3, lsb: 1E-3},
    {unit: "kR", dp: 2, lsb: 1E-2},
    {unit: "MR", dp: 4, lsb: 1E-1} ],

  [ {unit: "-",  dp: 3, lsb: 1E-7},
    {unit: "-",  dp: 3, lsb: 1E-6},
    {unit: "-",  dp: 3, lsb: 1E-5},
    {unit: "-",  dp: 3, lsb: 1E-4},
    {unit: "mA", dp: 3, lsb: 1E-6},
    {unit: "mA", dp: 2, lsb: 1E-5},
    {unit: "-",  dp: 2, lsb: 1E-1} ],
];

function formatValue(num, dp) {
  const factor = Math.pow(10, dp);
  return (num / factor).toFixed(dp);
}

function initWebSocket() {
  websocket = new WebSocket('ws://' + window.location.hostname + ':80/ws');
  websocket.onopen = function(event) {
    console.log('WebSocket connection established');
    msg = '{"tellconfig":1}';
    sendMessage(msg);
  };
  websocket.onmessage = function(event) {
    try {
      console.log('json:', event.data)
      const data = JSON.parse(event.data);
      if(data.count !== undefined && data.range !== undefined && func !== null && data.over !== undefined){
        range = data.range;
        dp = unitinfo[funcindex[func -1]][range -2].dp;
        unit = unitinfo[funcindex[func -1]][range -2].unit;
        if(data.over == 0){
          value = formatValue(data.count, dp);
        } else {
          value = 'OVER';
        }
        document.getElementById('value').innerText = `${value}`;
        document.getElementById('unit').innerText = `${unit}`;
        lsb = unitinfo[funcindex[func -1]][range -2].lsb;
        chartAdd(data.count * lsb);
      }

      if(data.error !== undefined){
        document.getElementById('value').innerText = `Error ${data.error}`;
      }
      
      if(data.func !== undefined){
        func = data.func;
        changeFuncBtnColor(func);
        changeRangeBtnLabel(func);
      }

      if(data.range !== undefined){
        range = data.range;
        changeRangeBtnColor(range);
      }

      if(data.speed !== undefined){
        speed = data.speed & 0x7;
        const btn = document.getElementById('btnRate');
        const speed_label = ['Slow', 'Mid', 'Fast'];
        btn.innerText = speed_label[speed -1];
      }

      if(data.flags !== undefined){
        flags = data.flags;
        let btn = document.getElementById('btnOffset');
        if(flags & FL_OFFSET){
          btn.style.backgroundColor = btnSelected;
        }
        if(~flags & FL_OFFSET){
          btn.style.backgroundColor = '';
        }
        btn = document.getElementById('btnRange1');
        if(flags & FL_MANUAL){
          btn.style.backgroundColor = '';
        }
        if(~flags & FL_MANUAL){
          btn.style.backgroundColor = btnSelected;
        }
        btn = document.getElementById('btnExt');
        let sel = document.getElementById('selExtsrc');
        if(flags & FL_EXTRIG){
          btn.style.backgroundColor = btnSelected;
          sel.style.backgroundColor = btnSelected;
        }
        if(~flags & FL_EXTRIG){
          btn.style.backgroundColor = '';
          sel.style.backgroundColor = '';
        }
      }

      if(data.extsrc !== undefined){
        let sel = document.getElementById('selExtsrc');
        sel.value = data.extsrc;
      }

      if(data.rec !== undefined){
        const recBtn = document.getElementById('recBtn');
        let isrec = data.rec === 1;;
        recBtn.classList.toggle('recording', isrec);
      }

    } catch (error) {
      console.error('Error parsing JSON:', error);
    }
  };
  websocket.onclose = function(event) {
    console.log('WebSocket connection closed');
  };
  websocket.onerror = function(error) {
    console.log('WebSocket error: ', error);
  };
}
     
function sendMessage(msg) {
  if (websocket && websocket.readyState === WebSocket.OPEN) {
    websocket.send(msg);
    console.log('Sent message: ', msg);
  } else {
    console.log('WebSocket is not open. Message not sent.');
  }
}

function onBtnFunc(func) {
  msg = `{"func":${func}}`;
  sendMessage(msg);
}

function onBtnRange(range){
  msg = `{"range":${range}}`;
  sendMessage(msg);
}

function onBtnRangeAuto(){
  if(~flags & FL_MANUAL){
    msg = `{"range":9}`;
  }
  if(flags & FL_MANUAL){
    msg = `{"range":1}`;
  }
  sendMessage(msg);
}

function onBtnRate(){
  if(speed < 3){
    speed = speed +1;
  } else {
    speed =1;
  } 
  msg = `{"speed":${speed}}`;
  sendMessage(msg);
}

function onBtnOffset(){
  if(flags & FL_OFFSET){
    msg = `{"offset":0}`;
  } else {
    msg = `{"offset":1}`;
  }
  sendMessage(msg);
}

function onBtnTrig(){
  msg = `{"acq":1}`;
  sendMessage(msg);
}

function onBtnExt(){
  if(flags & FL_EXTRIG){
    msg = `{"trig":1}`;
  }
  if(~flags & FL_EXTRIG){
    let src = document.getElementById('selExtsrc').value;
    msg = `{"trig":3,"extsrc":${src}}`;                            
  }
  sendMessage(msg);
}

function changeFuncBtnColor(func) {
  for (let i=1; i<7; i++) {
    const btn = document.getElementById(`btnFunc${i}`);
    btn.style.backgroundColor = ''; // Set default color
  }
  const btn = document.getElementById(`btnFunc${func}`);
  btn.style.backgroundColor = btnSelected;
}

function changeRangeBtnLabel(func) {
  const labels = [ ['20mV', '200mV', '2V' , '20V' , '200V' , '1000V' , '---' ],   // V
                   ['20R' , '200R' , '2kR', '20kR', '200kR', '2000kR', '20MR'],   // R
                   ['---' , '---'  , '---', '---',  '200mA', '2000mA', '---' ] ]; // A
  const label = labels[funcindex[func -1]];
  for(let i=2; i <9; i++) {
    const btn = document.getElementById(`btnRange${i}`);
    btn.innerText = label[i-2];
  }
}
        
let lastRange = null;
function changeRangeBtnColor(range) {
  if (lastRange === range) return;
  for(let i=2; i < 9; i++){
    const btn = document.getElementById(`btnRange${i}`);
    btn.style.backgroundColor = ''; // Default color
  }
  const btn = document.getElementById(`btnRange${range}`);
  btn.style.backgroundColor = btnSelected;
  lastRange = range;
}

let graphData = {
  labels: [],  // X axis
  datasets: [{
    label: 'Fluke',
    data: [],   // Y axis
    fill: false,
    borderColor : 'rgba(0,255,0,0.8)',
    backgroundColor : 'rgba(0,255,0,0.5)',
    parsing: false,
    animation: {delay: 0,}
  }]
};
    
let graphOptions = {
  animation: false,
  maintainAspectRatio: false,
  scales: {
    yAxes: [{
    }]
  },
  elements: {
    line: { tension: 0, },
    point: { radius: 0, }
  },
  legend: {
    display: false,
  },
  tooltips: {
    enabled: false
  }
};

let ctx = null;
let chart = null;
let area = null;

function initChart() {
  ctx = document.getElementById('myChart').getContext('2d');
  chart = new Chart(ctx, { type: 'line', data: graphData, options: graphOptions });
  chart.update();
  area = document.getElementById('chartArea');
  area.style.display = 'none';
  let btn = document.getElementById('btnAutofit');
  btn.style.backgroundColor = btnSelected;
  btn = document.getElementById('btnClear');
  btn.style.display = 'none';
}

function chartToggle() {
  const btnChart = document.getElementById('btnChart');
  const btnClear = document.getElementById('btnClear');
  if(area.style.display === 'none' || area.style.display === ''){
    area.style.display = 'block';
    btnChart.style.backgroundColor = btnSelected;
    btnClear.style.display = 'inline-block';
  } else {
    area.style.display = 'none';
    btnChart.style.backgroundColor = '';
    btnClear.style.display = 'none';
  }
}

function chartAdd(value) {
  if(area.style.display === 'block'){
    let time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(value);
    if(chart.data.labels.length > 500){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }
}
	    
let isAutoscale = false;
function changeYSpan(isManual) {
  const btn = document.getElementById('btnAutofit');
  if(isManual === 1){
    btn.style.backgroundColor = '';
    const ymax = parseFloat(document.getElementById('ymax').value);
    const ymin = parseFloat(document.getElementById('ymin').value);
    chart.options.scales.yAxes[0].ticks.max = ymax;
    chart.options.scales.yAxes[0].ticks.min = ymin;
    isAutoscale = false;
  } else {
    chart.options.scales.yAxes[0].ticks.max = undefined;
    chart.options.scales.yAxes[0].ticks.min = undefined;
    btn.style.backgroundColor = btnSelected;
    isAutoscale = true;
  }
  chart.update();
}

function clearChart() {
  chart.data.labels.splice(0);
  chart.data.datasets[0].data.splice(0);
  chart.update();
}

window.onload = function() {
  initWebSocket();
  initChart();
  loadSidebar();
};

function onChangeSelExtsrc() {
  let value = document.getElementById('selExtsrc').value;
  msg = `{"extsrc":${value}}`;
  sendMessage(msg);
}

function onBtnRec() {
  msg = `{"rec":1}`;
  sendMessage(msg);
}

function loadSidebar() {
  fetch('sidebar.html')
    .then(response => response.text())
    .then(data => {
        document.getElementById('sidebar').innerHTML = data;
        highlightActiveLink();
    })
    .catch(error => console.error('Error loading sidebar:', error));
}

function highlightActiveLink() {
  const pageId = 'measure';
  const links = document.querySelectorAll('.sidebar-link');
  links.forEach(link => {
    if (link.getAttribute('id') === pageId) {
      link.classList.add('active');
    }
  });
}

  </script>
  <script src = "/Chart.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="sidebar"></div>
    <div class="content">
      <style>
        .number-box {
          font-family: 'Roboto Mono';
          font-size: 40px;
          min-width: 10ch;
          display: inline-block;
          padding: 10px 20px;
          border: 2px solid #333;
          border-radius: 8px;
          font-weight: bold;
          background-color: #f9f9f9;
          margin: 10px;
          text-align: right;
        }
        .fixed-width {width: 60px;}
        .display-container {
          display: flex;
          align-items: center;
          gap: 1rem;
        }
        .rec-button {
          background: white;
          color: red;
          border: 2px solid red;
          border-radius: 9999px;
          padding: 0.5em 1em;
          font-size: 1rem;
          font-weight: bold;
          box-shadow: 0 0 8px rgba(255, 0, 0, 0.3);
          cursor: pointer;
          transition: all 0.2s ease;
        }
        .rec-button:hover {
          transform: scale(1.05);
          box-shadow: 0 0 12px rgba(255, 0, 0, 0.5);
        }
        .rec-button.recording {
          background: red;
          color: white;
          box-shadow: 0 0 12px rgba(255, 0, 0, 0.8);
        }
      </style>
      <div class="display-container">
        <div class="number-box">
          <span id="value" style="font-size: 40px; margin-bottom: 20px;">Value</span>
          <span id="unit"  style="font-size: 30px; margin-bottom: 10px;">V</span>
        </div>
        <button class="rec-button" id="recBtn" data-isrec="false" onclick="onBtnRec()">REC</button>
      </div>
      <div>
        <button class="fixed-width" id="btnFunc1" onclick="onBtnFunc('1')">DCV</button>
        <button class="fixed-width" id="btnFunc2" onclick="onBtnFunc('2')">ACV</button>
        <button class="fixed-width" id="btnFunc3" onclick="onBtnFunc('3')">R2W</button>
        <button class="fixed-width" id="btnFunc4" onclick="onBtnFunc('4')">R4W</button>
        <button class="fixed-width" id="btnFunc5" onclick="onBtnFunc('5')">DCmA</button>
        <button class="fixed-width" id="btnFunc6" onclick="onBtnFunc('6')">ACmA</button>
      </div>
      <div>
        <button class="fixed-width" id="btnRange2" onclick="onBtnRange('2')">20mV</button>
        <button class="fixed-width" id="btnRange3" onclick="onBtnRange('3')">200mV</button>
        <button class="fixed-width" id="btnRange4" onclick="onBtnRange('4')">2V</button>
        <button class="fixed-width" id="btnRange5" onclick="onBtnRange('5')">20V</button>
        <button class="fixed-width" id="btnRange6" onclick="onBtnRange('6')">200V</button>
        <button class="fixed-width" id="btnRange7" onclick="onBtnRange('7')">1000V</button>
        <button class="fixed-width" id="btnRange8" onclick="onBtnRange('8')">n/a</button>
        <button class="fixed-width" id="btnRange1" onclick="onBtnRangeAuto()">Auto</button>
      </div>
      <div>
        <button class="fixed-width" id="btnTrig" onclick="onBtnTrig()">Trig</button>
        <button class="fixed-width" id="btnExt" onclick="onBtnExt()">ExTrig</button>
        <select class="fixed-width" id="selExtsrc" onchange="onChangeSelExtsrc()">
          <option value="0">---</option>
          <option value="1">1s</option>
          <option value="2">2s</option>
          <option value="5">5s</option>
          <option value="10">10s</option>
          <option value="30">30s</option>
          <option value="60">60s</option>
          <option value="-1">BNC+</option>
          <option value="-2">BNC-</option>
        </select>
        <button class="fixed-width" id="btnRate" onclick="onBtnRate()">Slow</button>
        <button class="fixed-width" id="btnOffset" onclick="onBtnOffset()">Offset</button>
      </div>
      <button class="fixed-width" id="btnChart" onclick="chartToggle()">Plot</button>
      <button class="fixed-width" id="btnClear" onclick="clearChart()">Clear</button>
      <div id="chartArea">
        <div class="chart-container" style="position: relative; height: 400px; width: 90%;">
          <canvas id="myChart" width="600" height="400"></canvas>
        </div>
        <div>
          Y-Span:
          <label for='ymin'>Min</label><input class='fixed-width' type='text' id='ymin'>
          <label for='ymax'>Max</label><input class='fixed-width' type='text' id='ymax'>
          <button id='changeYSpan' onclick='changeYSpan(1)'>Apply</button>
          <button id='btnAutofit' onclick='changeYSpan(0)'>Autofit</button>
        </div>        
      </div>
    </div> <!-- content -->
  </div> <!-- container -->
</body>
</html>