<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Manager</title>
  <link rel="stylesheet" href="/styles.css">
  <script>

function loadSidebar() {
  fetch('/sidebar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('sidebar').innerHTML = data;
      highlightActiveLink();
    })
    .catch(error => console.error('Error loading sidebar:', error));
}

function highlightActiveLink() {
  const pageId = 'fileman';
  const links = document.querySelectorAll('.sidebar-link');
  links.forEach(link => {
    if (link.getAttribute('id') === pageId) {
      link.classList.add('active');
    }
  });
}

function setpath() {
  var default_path = document.getElementById("newfile").files[0].name;
  document.getElementById("filepath").value = default_path;
}

function upload() {
  var filePath = document.getElementById("filepath").value;
  var path = window.location.pathname;
  var upload_path = "/upload" + path + filePath;
  var fileInput = document.getElementById("newfile").files;

  /* Max size of an individual file. Make sure this
    * value is same as that set in file_server.c */
  var MAX_FILE_SIZE = 200*1024;
  var MAX_FILE_SIZE_STR = "200KB";

  if (fileInput.length == 0) {
    alert("No file selected!");
  } else if (filePath.length == 0) {
    alert("File path on server is not set!");
  } else if (filePath.indexOf(' ') >= 0) {
    alert("File path on server cannot have spaces!");
  } else if (filePath[filePath.length-1] == '/') {
    alert("File name not specified after path!");
  } else if (fileInput[0].size > MAX_FILE_SIZE) {
    alert(`File size must be less than ${MAX_FILE_SIZE_STR}!`);
  } else {
    document.getElementById("newfile").disabled = true;
    document.getElementById("filepath").disabled = true;
    document.getElementById("upload").disabled = true;
    var file = fileInput[0];
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == 4) {
        if (xhttp.status == 200) {
          document.open();
          document.write(xhttp.responseText);
          document.close();
        } else if (xhttp.status == 0) {
          alert("Server closed the connection abruptly!");
          location.reload()
        } else {
          alert(xhttp.status + " Error!\n" + xhttp.responseText);
          location.reload()
        }
      }
    };
    xhttp.open("POST", upload_path, true);
    xhttp.send(file);
  }
}

window.onload = loadSidebar();

  </script>
</head>
<body>
  <div class="container">
  <div id="sidebar"></div>
    <div class="content">
      <table style="width: 100%; border-collapse: collapse; border: 0px">
        <tr><td>
          <h1><span id="pathname"></span></h1>
          <script>
            const pathname = window.location.pathname;
            document.getElementById("pathname").textContent = pathname;
          </script>
        </td><td>
          <table style="margin-left: auto; border: 0px">
            <tr>
              <td style="text-align: right;">
                <label for="newfile">Upload a file</label>
              </td>
              <td colspan="2">
                <input id="newfile" type="file" onchange="setpath()" style="width:100%;">
              </td>
            </tr>
            <tr>
              <td>
                <label for="filepath">Set path on server</label>
              </td>
              <td>
                <input id="filepath" type="text" style="width:100%;">
              </td>
              <td>
                <button id="upload" type="button" onclick="upload()">Upload</button>
              </td>
            </tr>
          </table>
        </td></tr>
      </table>
      <!-- Dynamic generated contents below -->
